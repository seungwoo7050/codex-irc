# design/server/v0.3.0-parser-errors.md

## 개요
- 대상 버전: v0.3.0
- 목적: IRC 메시지 파서 규칙과 최소 에러 세트(파라미터 부족, 알 수 없는 명령, 길이 초과)를 고정한다.
- 관련 문서: design/protocol/contract.md

## 파서 규칙 요약
- prefix는 라인이 `:`로 시작할 때 첫 공백까지를 취한다. prefix 이후 연속된 공백은 모두 스킵한다.
- command는 prefix 이후 첫 토큰이며, 서버 내부 매칭 시 대문자로 정규화한다.
- params 파싱:
  - 공백으로 분리하되 연속 공백은 무시한다.
  - `:`로 시작하는 토큰은 trailing 파라미터로 간주하고 해당 위치 이후 전체를 단일 파라미터로 저장한다.
- 결과 구조체: prefix, command, params(vector)를 제공해 핸들러가 추가 문맥을 필요 시 활용할 수 있다.

## 에러 및 종료 정책
- 길이 초과: 512바이트(\r\n 포함)보다 긴 라인이 수신되면 에러 전송 없이 즉시 연결을 종료한다.
- PING/PONG 파라미터 부족: `409 ERR_NOORIGIN :출처 없음`을 전송한다.
- PASS/NICK/USER 파라미터 부족: `461 ERR_NEEDMOREPARAMS <command> :필수 파라미터 부족`을 전송한다.
- 등록 전 미허용 명령: `451 ERR_NOTREGISTERED :등록 필요`.
- 등록 완료 후 알 수 없는 명령: `421 ERR_UNKNOWNCOMMAND <command> :알 수 없는 명령`.
- QUIT: 메시지 유무와 무관하게 즉시 연결을 닫으며, 별도 브로드캐스트는 없다.

## 테스트 커버리지
- 단위: tests/unit/message_test.cpp – prefix/trailing/공백 처리를 포함한 파싱 확인.
- E2E:
  - tests/e2e/test_ping.py – PING/PONG 응답 형식 및 파라미터 부족 409 검증.
  - tests/e2e/test_quit_and_errors.py – QUIT 종료, 등록 후 421, 길이 초과 종료를 검증.
  - tests/e2e/test_registration.py – 등록 성공/거부 시나리오 유지 확인.

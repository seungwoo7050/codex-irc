# design/server/v0.2.0-registration.md

## 개요
- 목표: PASS/NICK/USER 등록 절차와 등록 전 커맨드 거부 정책 구현.
- 관련 계약: design/protocol/contract.md (v0.2.0)
- 테스트: tests/unit/message_test.cpp, tests/e2e/test_registration.py, tests/e2e/test_ping.py

## 설계 메모
- 파서: `protocol::ParseMessageLine`로 prefix/트레일링을 분리하고, 명령은 서버에서 대문자화한다.
- 닉네임 검증: 영문/숫자/`[]\\`_-`만 허용, 첫 글자는 영문/숫자. 중복은 접속 테이블 전체에서 차단.
- 상태: 클라이언트마다 `pass_accepted`, `nick`, `user_set`, `registered` 플래그를 보관한다.
- 등록 완료: PASS 성공 + NICK 설정 + USER 설정이 되면 즉시 `001` 환영 numeric을 송신.
- 거부 정책: 등록 전에는 PASS/NICK/USER/PING/QUIT만 허용하며, 기타 명령은 `451`로 응답한다.
- PASS 실패: 파라미터 부족(461) 또는 비밀번호 불일치(464) 시 numeric 송신 후 송신 큐를 비운 뒤 연결 종료.

## 테스트 포인트
- 단위: 파서가 트레일링 파라미터를 보존하고 닉네임 허용 문자만 통과하는지 확인.
- E2E:
  - PASS→NICK→USER 순서로 001 환영 메시지 수신.
  - PASS 누락/오류 시 numeric 후 연결 종료.
  - 등록 전 JOIN/PRIVMSG에 451 응답.

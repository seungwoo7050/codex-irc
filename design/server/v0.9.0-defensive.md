# design/server/v0.9.0-defensive.md

## 개요
- 목적: per-connection 레이트리밋과 송신 큐 백프레셔를 적용해 메시지 플러딩과 느린 소비자에 대한 방어 동작을 고정한다.
- 범위: PRIVMSG/NOTICE 발신 속도를 제한하고, 클라이언트 송신 큐가 상한(16라인)을 넘으면 즉시 종료하도록 한다.

## 레이트리밋 설계
- 파라미터: `limits.messages_per_5s`(기본 0) 값으로 5초 윈도우 내 허용 횟수를 정의한다. 0이면 레이트리밋을 비활성화한다.
- 자료구조: `ClientConnection.recent_messages`에 `steady_clock` 타임포인트 deque를 저장한다.
- 알고리즘: 명령 처리 시 PRIVMSG/NOTICE마다 윈도우 이전 항목을 제거한 뒤 현재 크기가 상한 이상이면 `439 ERR_RATEEXCEEDED`를 반환하고 메시지는 드롭한다. 허용되는 경우 타임포인트를 추가하고 정상 라우팅한다.
- 정책: 연결은 유지하며 윈도우가 식을 때까지 반복적으로 차단한다.

## 송신 큐 백프레셔
- 상한: 각 클라이언트별 16라인(deque), 5초 윈도우 내 큐잉 기준으로 초과 시 즉시 종료한다. 설정 파일의 `limits.outbound_lines`로 조정 가능하며 0 또는 미설정 시 기본값을 사용한다.
- 초과 시나리오: 송신 큐가 가득 찬 대상에게 더 보내야 할 때, 서버는 경고 로그(`fd`, `nick`)를 남기고 해당 클라이언트를 즉시 종료한다. 초과한 라인은 큐잉하지 않는다.
- 영향 범위: 브로드캐스트/단일 전송 모두 동일하게 적용하며, 종료된 클라이언트는 채널에서 정리된다.
- 보조 조치: 수신자가 느린 환경에서도 빠르게 포화되도록 클라이언트 소켓 `SO_SNDBUF`를 64바이트로 제한한다.

## 테스트 포인트
- 레이트리밋 E2E: 낮은 `messages_per_5s` 설정으로 5초 내 다수 PRIVMSG를 전송하면 `439` numeric이 반환되고 초과 메시지가 상대에게 전달되지 않는지 확인한다.
- 백프레셔 E2E: 레이트리밋을 끈 상태에서 수신자가 읽지 않는 채널에 다수 메시지를 밀어넣어 송신 큐가 상한을 넘으면 대상 연결이 종료되는지 확인한다.

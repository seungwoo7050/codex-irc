# v0.5.0 메시징 설계

## 개요
- 범위: PRIVMSG/NOTICE 라우팅, NAMES/LIST numeric 응답.
- 근거: `design/protocol/contract.md` v0.5.0 명세.
- 목표: 사용자 간/채널로의 메시지 전달과 기본 채널 메타 정보를 조회하는 명령을 제공한다.

## 명령 동작 요약
- PRIVMSG/NOTICE
  - 등록 필수. 대상 누락/본문 누락/대상 부재/채널 미가입 시 numeric으로 거부.
  - 닉네임 대상: `:<sender> PRIVMSG <nick> :<text>` 또는 NOTICE를 단일 수신자에게 전송.
  - 채널 대상: 채널 멤버 전체에게 브로드캐스트하되 발신자는 제외한다.
  - 채널 이름 검증은 JOIN과 동일하게 적용한다.
- NAMES
  - 단일 채널만 지원한다. 존재하는 채널이면 `353`으로 닉네임 목록을 반환하고 항상 `366`으로 종료한다.
- LIST
  - 파라미터 없는 전체 채널 목록만 지원한다.
  - `321` 시작 → 채널별 `322 <channel> <count> :-` → `323` 종료 순서로 전송한다.

## 주요 구현 포인트
- `PollServer::HandlePrivmsgNotice`
  - 공통 파라미터 검증을 거친 뒤 대상이 채널인지 닉네임인지에 따라 분기한다.
  - 닉네임 검색은 등록된 클라이언트에 한정하여 선형 탐색한다.
  - 채널 브로드캐스트는 기존 `BroadcastToChannel`에 `exclude_fd`를 추가해 발신자를 제외하는 방식으로 재사용한다.
- `PollServer::HandleNames`
  - 채널 멤버 집합을 순회하며 닉네임을 공백으로 이어 붙여 `353` payload를 구성한다.
  - 채널이 없을 때는 353을 생략하고 366만 전송한다.
- `PollServer::HandleList`
  - 채널 맵을 순회하며 현재 멤버 수를 `std::to_string`으로 변환해 `322` 라인을 만든다.
  - topic 기능이 없으므로 `:-`를 고정 문자열로 사용한다.

## 테스트 커버리지
- E2E(`tests/e2e/test_messaging.py`)
  - 사용자↔사용자 PRIVMSG 전달 확인.
  - 채널 브로드캐스트에서 발신자 prefix와 메시지 보존 확인.
  - NAMES 결과에 두 명의 닉네임이 포함되는지 검증.
  - LIST가 321/322/323 순서와 채널 인원수를 반환하는지 확인.

# design/server/v0.8.0-config-logging.md

## 개요
- 목적: INI 설정 파일을 통해 서버명/로그 레벨/레이트리밋 값을 주입하고, REHASH/SIGHUP으로 런타임 리로드를 가능하게 한다.
- 범위: v0.8.0에서 값 로드와 로깅 제어까지 포함하며, 레이트리밋 enforcement는 v0.9.0에서 사용될 예정이다.

## 설정 파일 규칙
- 경로: `./modern-irc <port> <password> [config_path]`에서 선택적으로 지정하며, 생략 시 `config/server.ini`를 시도한다(없으면 기본값 적용).
- 형식: INI (`[섹션]` + `키=값`), `#`/`;` 주석 허용, 섹션·키는 소문자로 비교한다.
- 지원 키와 기본값:
  - `[server] name` – 기본 `modern-irc`, numeric prefix 및 사용자 prefix 호스트에 사용.
  - `[logging] level` – 기본 `info`, 허용 `debug|info|warn|error`.
  - `[logging] file` – 기본 빈 값(`-` 동일) → stderr, 그 외 경로는 append 모드로 연다.
  - `[limits] messages_per_5s` – 기본 `0`(비활성), 현재는 로드만 수행.
- 검증: 알 수 없는 섹션/키, 비어 있는 name, 잘못된 level/숫자는 로드 실패로 처리하며 이전 설정을 유지한다.

## 로깅 설계
- Logger 클래스가 `config::LogLevel`을 받아 필터링하며, 출력 경로는 설정값에 따라 stderr 또는 파일(ofstream append)로 결정한다.
- REHASH/SIGHUP으로 설정이 바뀌면 `ApplyConfig`에서 레벨·출력 경로를 즉시 반영하고, 이후 로그는 새 경로를 사용한다.
- 로깅 메시지는 주로 설정 리로드 성공/실패, accept 오류 등 운영 이벤트에 한정한다.

## 리로드 흐름
1. 프로세스 시작 시 설정을 한 번 로드 후 `config_path_`를 저장한다.
2. SIGHUP 발생: 신호 핸들러가 플래그만 세팅 → 이벤트 루프가 `HandlePendingReload`에서 플래그를 확인 후 재로드.
3. REHASH 명령: 등록 완료 클라이언트만 허용, 즉시 설정을 다시 읽고 성공 시 `382`, 실패 시 `468` numeric으로 통보한다.
4. 성공 시 새 서버명이 prefix에 반영되므로 이후 응답/REHASH 결과 모두 새 이름을 사용한다.

## 테스트 포인트
- 단위: 잘못된 키/값 거부, 누락 시 기본값 적용, 정상 파일 파싱 후 필드 값 확인.
- E2E: 설정 파일에서 시작 서버명을 읽어 환영 numeric prefix로 확인 → 파일을 수정 후 REHASH → `382` 성공과 이후 에러 numeric prefix가 새 서버명으로 전환되는지 확인.

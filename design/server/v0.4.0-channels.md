# v0.4.0 채널 설계 메모

## 개요
- 목적: JOIN/PART를 지원하며 채널 멤버십과 입장/퇴장 브로드캐스트를 관리한다.
- 범위: 단일 스레드 poll 루프 내에서 채널 상태를 관리하고 연결 종료 시에도 멤버십을 정리한다.

## 데이터 구조
- `clients_[fd].joined_channels`: 클라이언트가 속한 채널 이름 집합.
- `channels_[name]`: 채널 상태 맵.
  - `members`: 채널에 속한 fd 집합.

## JOIN 처리 흐름
1. 등록 여부 확인 후 미등록이면 `451` 반환.
2. 파라미터/채널 이름 검증 실패 시 `461`/`476`/`443`을 반환한다.
3. 채널 상태를 만들거나 재사용하고 멤버십을 추가한다.
4. `:<nick>!<user>@modern-irc JOIN <channel>` 을 채널 전체(자신 포함)에 브로드캐스트한다.

## PART 처리 흐름
1. 등록 여부와 파라미터를 확인하고 부족하면 `461`을 반환한다.
2. 채널 이름 형식 오류 시 `476`, 미가입 상태면 `442`를 반환한다.
3. reason이 없으면 `사용자 요청`으로 대체한다.
4. `:<nick>!<user>@modern-irc PART <channel> :<reason>` 을 채널 전체(자신 포함)에 브로드캐스트한다.
5. 멤버십을 제거하고 채널이 비면 맵에서 삭제한다.

## 연결 종료 처리
- `CloseClient`는 항상 `RemoveFromAllChannels(fd, "연결 종료")`를 호출한다.
- 모든 채널에 PART 브로드캐스트 후 멤버십을 제거하여 이후 브로드캐스트 대상에서 제외한다.

## 보조 함수
- `IsValidChannelName`: `#` 시작, 2~50자, 영문/숫자/`_`/`-`만 허용.
- `BuildUserPrefix`: `:<nick>!<username>@modern-irc` 포맷을 생성.
- `BroadcastToChannel`: 현재 멤버 fd 복사본에 대해 메시지를 전송하고 큐 초과 시 연결을 정리한다.

# design/protocol/contract.md

## 개요 (v0.1.0)
- 본 문서는 modern-irc 서버의 외부 프로토콜 계약을 정의한다.
- v0.1.0은 최소 동작 스모크 버전으로, CRLF 프레이밍과 기본 PING→PONG 응답만을 제공한다.

---

## 연결 및 CLI
- 실행 방법: `./modern-irc <port> <password>`
  - `<port>`: IPv4 TCP 포트 번호.
  - `<password>`: 서버 공유 비밀번호. v0.1.0에서는 인증 절차에 사용하지 않으며, 추후 버전에서 PASS 명령 검증용으로 예약한다.
- 서버는 IPv4에서 `INADDR_ANY`로 바인드하며, `poll()` 기반 단일 스레드 이벤트 루프로 동작한다.

---

## 입력 프레이밍 정책
- 메시지 구분자는 CRLF(`\r\n`)이다.
- 각 클라이언트는 개별 입력 버퍼를 가진다.
  - 부분 수신을 허용하며, CRLF가 도달할 때까지 버퍼링한다.
- 라인 최대 길이: **512바이트(종료 CRLF 포함)**
  - CRLF를 찾았을 때, 해당 라인이 512바이트를 초과하면 즉시 연결을 종료한다.
  - CRLF가 오지 않은 상태에서 버퍼가 512바이트를 넘으면 버퍼를 비우고 연결을 종료한다.

---

## 출력 큐(백프레셔) 정책
- 각 클라이언트는 송신 대기열(deque<string>)을 가진다.
- 상한: **64개 라인**.
- 새 라인을 추가하려 할 때 큐가 가득 차 있으면, 해당 클라이언트를 로그만 남기고 종료한다(추가 드롭 없이 종료).

---

## 지원 명령 (v0.1.0)
- PING
  - 요청 형식: `PING <payload>`
  - 응답 형식: `PONG <payload>`\r\n
  - `<payload>`는 공백 없는 토큰을 기대하며, 비어 있으면 빈 문자열 그대로 반사한다.
- 그 외 명령은 v0.1.0에서 정의되지 않았으며, 수신 시 무시 없이 연결을 종료하지 않는다(단, 라인 길이 초과 정책은 동일하게 적용).

---

## 오류 처리
- 라인 길이 초과: 연결 종료.
- 송신 큐 초과: 연결 종료.
- 소켓 오류 또는 EOF: 연결 종료.
- 응답 포맷: v0.1.0에서는 별도 에러 메시지를 보내지 않고 종료한다.

---

## CRLF 보장
- 서버가 보내는 모든 응답 라인은 CRLF(`\r\n`)로 종료된다.
